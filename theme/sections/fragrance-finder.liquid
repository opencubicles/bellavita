<!-- FULL DYNAMIC FRAGRANCE FINDER (copy/paste over your existing block) -->
{% schema %}
{
  "name": "Fragrance Finder App",
  "settings": []
}
{% endschema %}

<style>
 
/* WRAPPER */
.ff-wrapper {
  padding: 60px 20px;
  background: #f2f2f2;
  min-height: 100vh;
  font-family: "Outfit", sans-serif;
}

/* MAIN CONTAINER */
.ff-main {
  max-width: 900px;
  margin: 0 auto;
  text-align: center;
}

/* ALIGN WRAPPER for progress + back button */
.ff-align {
  max-width: 900px;
  margin: 0 auto;
  text-align: left;
  padding: 0 20px;
}

/* HEADER */
.ff-header h1 { font-size: 28px; margin: 0; font-weight: 700; }
.ff-header p { color: #555; margin: 4px 0 20px; }

/* PROGRESS */
.ff-progress-wrap { margin-bottom: 8px; display:none; }
.ff-progress-text { display: flex; justify-content: space-between; font-size: 13px; color: #444; }
.ff-progress-track { width: 100%; height: 6px; background: #e9e9e9; border-radius: 10px; margin-top: 6px; }
.ff-progress-bar { height: 6px; width: 0%; background: #1267C6; border-radius: 10px; transition: width .3s; }

/* BACK BUTTON */
.ff-global-back {
  display: none;
  margin: 12px 0 0;
  padding-left: 3px;
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  color: #222;
}

/* MAIN CARD */
.ff-card {
  margin-top: 20px;
  background: #fff;
  border-radius: 28px;
  padding: 40px 30px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.08);
}

/* INTRO STEP 0 */
.ff-intro-icon { font-size: 42px; color: #a855f7; }
.ff-intro-title { font-size: 32px; font-weight: 700; margin: 12px 0; }
.ff-intro-sub { color: #666; margin-bottom: 30px; font-size: 16px; }
.ff-start-btn {
  background: #000000;
  padding: 14px 36px;
  border-radius: 30px;
  color: #fff;
  text-decoration: none;
  font-size: 16px;
  display: inline-block;
}

/* TITLE */
.ff-title { font-size: 28px; font-weight: 700; margin-bottom: 25px; }

/* OPTIONS */
.ff-options { display: grid; gap: 20px; }

.ff-option {
  padding: 25px;
  border: 2px solid #eee;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.2s;
  text-align: center;
}
.ff-option:hover { transform: scale(1.02); border-color: #d9c7ff; }

.ff-option h3 { margin: 10px 0 5px; font-size: 20px; }
.ff-option p { color: #666; margin: 0; font-size: 14px; }
.ff-icon { font-size: 34px; margin-bottom: 6px; }

/* LIST TYPE STEPS (left aligned) */
.ff-list .ff-option { text-align: left; }

/* RESULTS */
.ff-results { margin-top: 20px; }

/* PRODUCT CARD */
.ff-product-card {
  background: #fff;
  border-radius: 18px;
  overflow: hidden;
  margin-bottom: 30px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}

.ff-product-img {
  width: 100%;
  height: auto;
  max-height: 420px;      /* controls height but doesn‚Äôt crop */
  object-fit: contain;    /* shows full bottle */
  background: #f5f5f5;
  padding: 20px;          /* better framing */
  border-radius: 12px;
}

.ff-product-info {
  padding: 18px 22px;
}

.ff-product-info h4 {
  font-size: 18px;
  font-weight: 700;
  margin: 0 0 4px;
}

.ff-product-info p {
  margin: 0;
  color: #666;
  font-size: 14px;
}

.ff-product-bottom {
  margin-top: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.ff-price {
  color: #c026d3;
  font-size: 18px;
  font-weight: 700;
}

.ff-shop-btn {
  background: linear-gradient(90deg,#a855f7,#ec4899);
  color: #fff;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  text-decoration: none;
}

.ff-footer {
  margin-top: 40px;
  color: #777;
}
/* list option: icon left, text column on the right */
.ff-list .ff-option {
  display: flex;
  align-items: center;      /* vertical center the icon and text block */
  gap: 18px;                /* spacing between icon and text */
  padding: 14px 18px;
  border-radius: 12px;
  border: 1.5px solid #e9ecef;
  background: #fff;
}

/* icon size and fixed box so text doesn't shift */
.ff-list .ff-option .ff-icon {
  font-size: 30px;
  width: 48px;
  text-align: center;
  flex-shrink: 0;
  margin: 0;
  line-height: 1;
}

/* text column: title above subtitle */
.ff-list .ff-option .ff-option-text {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

/* title */
.ff-list .ff-option .ff-option-text h3 {
  margin: 0;
  font-size: 18px;
  line-height: 1.06;
  font-weight: 700;
}

/* subtitle under title */
.ff-list .ff-option .ff-option-text p {
  margin: 6px 0 0;
  color: #666;
  font-size: 13px;
  line-height: 1.3;
}

/* small helper for empty state */
.ff-empty { color:#666; padding:18px; border-radius:12px; background:#fff; border:1px dashed #eee; }
.ff-out-of-stock {
  display: none !important;
}
</style>

<div class="ff-wrapper">
  <div class="ff-main">

    <!-- HEADER -->
    <div class="ff-header">
      <h1>Bella Vita Luxury</h1>
      <p>Fragrance Finder</p>
    </div>

    <!-- PROGRESS + BACK BUTTON WRAPPER -->
    <div class="ff-align">
      <div class="ff-progress-wrap" id="ff-progress-wrap">
        <div class="ff-progress-text">
          <span>Progress</span>
          <span id="ff-step-text">Step 1 of 4</span>
        </div>
        <div class="ff-progress-track">
          <div id="ff-progress-bar" class="ff-progress-bar"></div>
        </div>
      </div>

      <!-- BACK BUTTON -->
      <button id="ff-global-back" class="ff-global-back">‚Üê Back</button>
    </div>

    <!-- MAIN CARD -->
    <div class="ff-card">

      <!-- STEP 0: INTRO -->
      <div class="ff-step" data-step="0">
        <div class="ff-intro-icon">‚ú®</div>
        <div class="ff-intro-title">Still Scent-less? Don‚Äôt Overthink</div>
        <div class="ff-intro-sub">Find your perfect perfume in just 3 steps</div>
        <a class="ff-start-btn" id="ff-start">Find My Fragrance ‚Üí</a>
      </div>

      <!-- STEP 1 -->
      <div class="ff-step" data-step="1" style="display:none;">
        <h2 class="ff-title" id="ff-title-step1">Who Are You Shopping For?</h2>
        <div id="step2-options" class="ff-options"></div>
      </div>

      <!-- STEP 2 -->
      <div class="ff-step" data-step="2" style="display:none;">
        <h2 class="ff-title" id="ff-title-step2">Who Is This Gift For?</h2>
        <div id="step3-options" class="ff-options"></div>
      </div>

      <!-- STEP 3 -->
      <div class="ff-step" data-step="3" style="display:none;">
        <h2 class="ff-title" id="ff-title-step3">What Type of Scent Do You Like?</h2>
        <div id="step4-options" class="ff-options ff-list"></div>
      </div>

      <!-- STEP 4 -->
      <div class="ff-step" data-step="4" style="display:none;">
        <h2 class="ff-title" id="ff-title-step4">When Will You Wear It?</h2>
        <div id="step5-options" class="ff-options ff-list"></div>
      </div>

      <!-- STEP 5 RESULTS -->
      <div class="ff-step" data-step="5" style="display:none;">
        <h2 class="ff-title">FOUND IT! Top Picks For You</h2>
        <p class="ff-sub" style="color:#666;margin-bottom:20px;">Based on your preferences, here are your perfect matches</p>

        <div id="ff-results" class="ff-results"></div>

      </div>

    </div>

    <p class="ff-footer">‚ú® IFRA Certified ‚Ä¢ Cruelty Free ‚Ä¢ Imported Oils</p>

  </div>
</div>

<script>
(function(){

  /***********************
   * 1) YOUR CLEAN JSON  *
   * (sanitized & used)  *
   ***********************/
 
  const FRAGRANCE_DATA = [{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Fresh & Citrusy","Step 5: Occasion":"Everyday / Work","Perfect Match":"ceo-man-luxury-perfume","Best Alternative":"alpha-him-3-4-fl-oz","Premium/Niche":"fresh-unisex-perfume-3-4-fl-oz","Cross-Category":"skai-aquatic-unisex-perfume-3-4-fl-oz","Best Value Combo":"trendsetter-ceo-man-white-oud"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Fresh & Citrusy","Step 5: Occasion":"Active / Gym","Perfect Match":"ocean-man-perfume","Best Alternative":"skai-aquatic-unisex-perfume-3-4-fl-oz","Premium/Niche":"fresh-unisex-perfume-3-4-fl-oz","Cross-Category":"ceo-man-luxury-perfume","Best Value Combo":"sigma-male-ceo-man-g-o-a-t-man"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Fresh & Citrusy","Step 5: Occasion":"Date / Night","Perfect Match":"magnetic-him-3-4-fl-oz","Best Alternative":"alpha-him-3-4-fl-oz","Premium/Niche":"embarouge-urban-oud","Cross-Category":"ceo-man-luxury-perfume","Best Value Combo":"sharp-sexy-ceo-man-honey-oud"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Woody & Earthy","Step 5: Occasion":"Everyday / Work","Perfect Match":"g-o-a-t-man-perfume-3-4-fl-oz","Best Alternative":"white-oud-unisex-perfume-3-4-fl-oz","Premium/Niche":"embarouge-22-north","Cross-Category":"alpha-him-3-4-fl-oz","Best Value Combo":"sigma-male-ceo-man-g-o-a-t-man"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Woody & Earthy","Step 5: Occasion":"Special / Luxury","Perfect Match":"oud-perfume-3-4-fl-oz","Best Alternative":"g-o-a-t-man-perfume-3-4-fl-oz","Premium/Niche":"embarouge-monark","Cross-Category":"oud-dark-3-4-fl-oz","Best Value Combo":"all-kings"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Woody & Earthy","Step 5: Occasion":"Date / Mystery","Perfect Match":"oud-dark-3-4-fl-oz","Best Alternative":"g-o-a-t-man-perfume-3-4-fl-oz","Premium/Niche":"embarouge-kama-noir","Cross-Category":"fantasy-him-3-4-fl-oz","Best Value Combo":"the-best-the-beast"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Spicy & Bold","Step 5: Occasion":"Party / Energy","Perfect Match":"klub-man-perfume-3-4-fl-oz","Best Alternative":"oud-dark-3-4-fl-oz","Premium/Niche":"embarouge-monark","Cross-Category":"fantasy-him-3-4-fl-oz","Best Value Combo":"all-kings"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Spicy & Bold","Step 5: Occasion":"Date / Sensual","Perfect Match":"fantasy-him-3-4-fl-oz","Best Alternative":"klub-man-perfume-3-4-fl-oz","Premium/Niche":"embarouge-oud-studio","Cross-Category":"magnetic-him-3-4-fl-oz","Best Value Combo":"the-best-the-beast"},{"Step 2":"For Myself","Step 3":"Him","Step 4: Scent":"Sweet & Fruity","Step 5: Occasion":"Romantic / Soft","Perfect Match":"magnetic-him-3-4-fl-oz","Best Alternative":"honey-oud-unisex-perfume-3-4-fl-oz","Premium/Niche":"vanilla-gourmet-collection","Cross-Category":"white-oud-unisex-perfume-3-4-fl-oz","Best Value Combo":"sharp-sexy-ceo-man-honey-oud"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Floral","Step 5: Occasion":"Chic / Brunch","Perfect Match":"senorita-woman-perfume-3-4-fl-oz","Best Alternative":"alpha-her-3-4-fl-oz","Premium/Niche":"embarouge-luxeria","Cross-Category":"rose-woman-perfume-3-4-fl-oz","Best Value Combo":"girls-night-out-date-woman-senorita-woman"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Floral","Step 5: Occasion":"Elegant / Classic","Perfect Match":"rose-woman-perfume-3-4-fl-oz","Best Alternative":"senorita-woman-perfume-3-4-fl-oz","Premium/Niche":"embarouge-22-north","Cross-Category":"embarouge-luxeria","Best Value Combo":"all-queens"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Floral","Step 5: Occasion":"Party / Bold","Perfect Match":"glam-woman-perfume","Best Alternative":"rose-woman-perfume-3-4-fl-oz","Premium/Niche":"embarouge-luxeria","Cross-Category":"fantasy-her-3-4-fl-oz","Best Value Combo":"double-trouble"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Sweet & Fruity","Step 5: Occasion":"Date / Romance","Perfect Match":"date-woman-perfume-3-4-fl-oz","Best Alternative":"magnetic-her-3-4-fl-oz","Premium/Niche":"honey-oud-unisex-perfume-3-4-fl-oz","Cross-Category":"vanilla-gourmet-collection","Best Value Combo":"girls-night-out-date-woman-senorita-woman"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Sweet & Fruity","Step 5: Occasion":"Sensual / Night","Perfect Match":"magnetic-her-3-4-fl-oz","Best Alternative":"date-woman-perfume-3-4-fl-oz","Premium/Niche":"pistachio-gourmet-collection","Cross-Category":"fantasy-her-3-4-fl-oz","Best Value Combo":"too-sweet-too-sexy-white-oud-honey-oud"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Fresh & Citrusy","Step 5: Occasion":"Confidence / Work","Perfect Match":"alpha-her-3-4-fl-oz","Best Alternative":"senorita-woman-perfume-3-4-fl-oz","Premium/Niche":"fresh-unisex-perfume-3-4-fl-oz","Cross-Category":"skai-aquatic-unisex-perfume-3-4-fl-oz","Best Value Combo":"girls-night-out-date-woman-senorita-woman"},{"Step 2":"For Myself","Step 3":"Her","Step 4: Scent":"Spicy & Bold","Step 5: Occasion":"Intense / Night","Perfect Match":"fantasy-her-3-4-fl-oz","Best Alternative":"glam-woman-perfume","Premium/Niche":"oud-dark-3-4-fl-oz","Cross-Category":"embarouge-kama-noir","Best Value Combo":"all-queens"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Fresh & Citrusy","Step 5: Occasion":"Clean / Daily","Perfect Match":"fresh-unisex-perfume-3-4-fl-oz","Best Alternative":"skai-aquatic-unisex-perfume-3-4-fl-oz","Premium/Niche":"embarouge-urban-oud","Cross-Category":"ocean-man-perfume","Best Value Combo":"green-cream-vanilla-pistachio"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Fresh & Citrusy","Step 5: Occasion":"Sporty / Summer","Perfect Match":"skai-aquatic-unisex-perfume-3-4-fl-oz","Best Alternative":"ocean-man-perfume","Premium/Niche":"fresh-unisex-perfume-3-4-fl-oz","Cross-Category":"alpha-him-3-4-fl-oz","Best Value Combo":"double-trouble"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Sweet & Fruity","Step 5: Occasion":"Summer Fun","Perfect Match":"mango-gourmet-collection","Best Alternative":"pistachio-gourmet-collection","Premium/Niche":"honey-oud-unisex-perfume-3-4-fl-oz","Cross-Category":"date-woman-perfume-3-4-fl-oz","Best Value Combo":"the-mvp-trio-mango-vanilla-pistachio"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Sweet & Fruity","Step 5: Occasion":"Warm / Luxury","Perfect Match":"honey-oud-unisex-perfume-3-4-fl-oz","Best Alternative":"vanilla-gourmet-collection","Premium/Niche":"embarouge-oud-studio","Cross-Category":"Oud Gold","Best Value Combo":"too-sweet-too-sexy-white-oud-honey-oud"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Sweet & Fruity","Step 5: Occasion":"Cozy / Comfort","Perfect Match":"vanilla-gourmet-collection","Best Alternative":"pistachio-gourmet-collection","Premium/Niche":"honey-oud-unisex-perfume-3-4-fl-oz","Cross-Category":"magnetic-her-3-4-fl-oz","Best Value Combo":"green-cream-vanilla-pistachio"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Woody & Earthy","Step 5: Occasion":"Spiritual / Calm","Perfect Match":"white-oud-unisex-perfume-3-4-fl-oz","Best Alternative":"oud-perfume-3-4-fl-oz","Premium/Niche":"embarouge-22-north","Cross-Category":"fresh-unisex-perfume-3-4-fl-oz","Best Value Combo":"trendsetter-ceo-man-white-oud"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Woody & Earthy","Step 5: Occasion":"Nutty / Unique","Perfect Match":"pistachio-gourmet-collection","Best Alternative":"white-oud-unisex-perfume-3-4-fl-oz","Premium/Niche":"honey-oud-unisex-perfume-3-4-fl-oz","Cross-Category":"embarouge-oud-studio","Best Value Combo":"sweet-nutty-mango-pistachio"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Spicy & Bold","Step 5: Occasion":"Statement / Regal","Perfect Match":"embarouge-monark","Best Alternative":"oud-perfume-3-4-fl-oz","Premium/Niche":"embarouge-kama-noir","Cross-Category":"g-o-a-t-man-perfume-3-4-fl-oz","Best Value Combo":"all-kings"},{"Step 2":"For Myself","Step 3":"Unisex","Step 4: Scent":"Spicy & Bold","Step 5: Occasion":"Night / Seductive","Perfect Match":"embarouge-kama-noir","Best Alternative":"oud-dark-3-4-fl-oz","Premium/Niche":"embarouge-oud-studio","Cross-Category":"fantasy-him-3-4-fl-oz","Best Value Combo":"the-best-the-beast"},{"Step 2":"For Gifting","Step 3":"Him","Step 4: Scent":"Discovery","Step 5: Occasion":"Minis / Variety","Perfect Match":"perfume-gift-set-for-men-4-x-0-7-fl-oz","Best Alternative":"him-her-gift-set-8-in-1-multi-pack","Premium/Niche":"unisex-perfume-gift-set-4-x-0-7-fl-oz","Cross-Category":"build-your-own-box-3-for-45","Best Value Combo":"himn-more-8-in-1-multi-pack"},{"Step 2":"For Gifting","Step 3":"Him","Step 4: Scent":"Big Bundle","Step 5: Occasion":"Best Sellers","Perfect Match":"sigma-male-ceo-man-g-o-a-t-man","Best Alternative":"trendsetter-ceo-man-white-oud","Premium/Niche":"sharp-sexy-ceo-man-honey-oud","Cross-Category":"all-kings","Best Value Combo":"the-best-the-beast"},{"Step 2":"For Gifting","Step 3":"Her","Step 4: Scent":"Discovery","Step 5: Occasion":"Minis / Variety","Perfect Match":"perfume-gift-set-for-women-4-x-0-7-fl-oz","Best Alternative":"him-her-gift-set-8-in-1-multi-pack","Premium/Niche":"unisex-perfume-gift-set-4-x-0-7-fl-oz","Cross-Category":"build-your-own-box-3-for-45","Best Value Combo":"hern-more-8-in-1-multi-pack"},{"Step 2":"For Gifting","Step 3":"Her","Step 4: Scent":"Big Bundle","Step 5: Occasion":"Best Sellers","Perfect Match":"girls-night-out-date-woman-senorita-woman","Best Alternative":"all-queens","Premium/Niche":"double-trouble","Cross-Category":"the-69-duo","Best Value Combo":"too-sweet-too-sexy-white-oud-honey-oud"},{"Step 2":"For Gifting","Step 3":"Couple","Step 4: Scent":"Discovery","Step 5: Occasion":"Variety Pack","Perfect Match":"him-her-gift-set-8-in-1-multi-pack","Best Alternative":"unisex-perfume-gift-set-4-x-0-7-fl-oz","Premium/Niche":"him-her-gift-set-8-in-1-multi-pack","Cross-Category":"build-your-own-box-3-for-45","Best Value Combo":"him-her-gift-set-8-in-1-multi-pack"},{"Step 2":"For Gifting","Step 3":"Couple","Step 4: Scent":"Big Bundle","Step 5: Occasion":"Romantic Duo","Perfect Match":"the-69-duo","Best Alternative":"double-trouble","Premium/Niche":"kings-queens","Cross-Category":"too-sweet-too-sexy-white-oud-honey-oud","Best Value Combo":"unisex-perfume-gift-set-4-x-0-7-fl-oz"},{"Step 2":"For Gifting","Step 3":"Unisex","Step 4: Scent":"Gourmet","Step 5: Occasion":"Foodie Scents","Perfect Match":"the-mvp-trio-mango-vanilla-pistachio","Best Alternative":"green-cream-vanilla-pistachio","Premium/Niche":"sweet-nutty-mango-pistachio","Cross-Category":"the-cheeky-sundae-mango-vanilla","Best Value Combo":"the-cheeky-sundae-mango-vanilla"},{"Step 2":"For Gifting","Step 3":"Unisex","Step 4: Scent":"Discovery","Step 5: Occasion":"Variety Pack","Perfect Match":"unisex-perfume-gift-set-4-x-0-7-fl-oz","Best Alternative":"him-her-gift-set-8-in-1-multi-pack","Premium/Niche":"build-your-own-box-3-for-45","Cross-Category":"perfume-gift-set-for-men-4-x-0-7-fl-oz","Best Value Combo":"Woperfume-gift-set-for-men-4-x-0-7-fl-oz"}];
  const steps = document.querySelectorAll(".ff-step");
  const progressBar = document.getElementById("ff-progress-bar");
  const stepText = document.getElementById("ff-step-text");
  const progressWrap = document.getElementById("ff-progress-wrap");
  const backBtn = document.getElementById("ff-global-back");
  const startBtn = document.getElementById("ff-start");

  const step2Container = document.getElementById("step2-options");
  const step3Container = document.getElementById("step3-options");
  const step4Container = document.getElementById("step4-options");
  const step5Container = document.getElementById("step5-options");
  const resultsBox = document.getElementById("ff-results");

  let currentStep = 0;        // 0..5
  const totalSteps = 4;       // steps 1..4 are the selectable steps
  const selection = {};       // selection.step2, step3, step4, step5

  /*****************************
   * 3) ICON MAPS (keep icons)
   *****************************/
  const ICONS = {
    "For Myself": "üßë",
    "For Gifting": "üéÅ",
    "Him": "üëî",
    "Her": "üëó",
    "Unisex": "‚ú®",
    "Couple": "üíë",
    "Fresh & Citrusy": "üçã",
    "Floral": "üå∏",
    "Sweet & Fruity": "üçØ",
    "Woody & Earthy": "üå≤",
    "Spicy & Bold": "üå∂Ô∏è",
    // Gift/uncommon scents / bundles - default to sparkle
    "Discovery": "üîç",
    "Big Bundle": "üì¶",
    "Gourmet": "üç®",
    "Default": "‚ú®"
  };

  /*****************************
   * 4) UTIL: unique reducer
   *****************************/
  function unique(arr){
    return Array.from(new Set(arr));
  }

  /*****************************
   * 5) GENERATORS: create option DOM nodes
   *****************************/
  function createOption({label, subtitle, isList=false}){
    const el = document.createElement("div");
    el.className = "ff-option";
    el.setAttribute("data-value", label);

    if(isList){
      // list style (icon left + text)
      el.classList.add("ff-list-item");
      const iconSpan = document.createElement("span");
      iconSpan.className = "ff-icon";
      iconSpan.textContent = ICONS[label] || ICONS["Default"];

      const right = document.createElement("div");
      right.className = "ff-option-text";
      const h3 = document.createElement("h3");
      h3.textContent = label;
      right.appendChild(h3);
      if(subtitle){
        const p = document.createElement("p");
        p.textContent = subtitle;
        right.appendChild(p);
      }

      el.appendChild(iconSpan);
      el.appendChild(right);
    } else {
      // card style
      const icon = document.createElement("div");
      icon.className = "ff-icon";
      icon.textContent = ICONS[label] || ICONS["Default"];
      const h3 = document.createElement("h3");
      h3.textContent = label;
      if(subtitle){
        const p = document.createElement("p");
        p.textContent = subtitle;
        el.appendChild(icon);
        el.appendChild(h3);
        el.appendChild(p);
      } else {
        el.appendChild(icon);
        el.appendChild(h3);
      }
    }

    // click handler will be attached externally
    return el;
  }

  function updateTitlesByPurpose() {
    const step2Title = document.getElementById("ff-title-step2");
    const step3Title = document.getElementById("ff-title-step3");
    const step4Title = document.getElementById("ff-title-step4");

    if (!selection.step2) return;

    if (selection.step2 === "For Myself") {
      step2Title.textContent = "Choose your category";
      step3Title.textContent = "What Type of Scent Do You Like?";
      step4Title.textContent = "When will you wear it?";
    }

    if (selection.step2 === "For Gifting") {
      step2Title.textContent = "Who Is This Gift For?";
      step3Title.textContent = "What kind of collection would you like to Gift?";
      step4Title.textContent = "What kind of packs would you like to Gift?";
    }
  }

  /*****************************
   * 6) RENDER STEP 2 OPTIONS
   *****************************/
  function renderStep2(){
    step2Container.innerHTML = "";
    const step2Options = ["For Myself", "For Gifting"];
    if(!step2Options.length){
      step2Container.innerHTML = '<div class="ff-empty">No options available.</div>';
      return;
    }
    step2Options.forEach(label=>{
      const opt = createOption({label, subtitle: null, isList:false});
      opt.addEventListener("click", ()=> {
        selection.step2 = label;
        // reset deeper selections
        delete selection.step3; delete selection.step4; delete selection.step5;

        updateTitlesByPurpose();   // ‚úÖ ADD THIS
        renderStep3();
        showStep(2);
      });
      step2Container.appendChild(opt);
    });
  }

  /*****************************
   * 7) RENDER STEP 3 OPTIONS (depends on step2)
   *****************************/
  function renderStep3(){
    step3Container.innerHTML = "";
    if(!selection.step2){
      step3Container.innerHTML = '<div class="ff-empty">Choose who you are shopping for first.</div>';
      return;
    }
    const matches = FRAGRANCE_DATA.filter(i => i["Step 2"] === selection.step2);
    const step3Options = unique(matches.map(i => i["Step 3"])).sort();
    if(!step3Options.length){
      step3Container.innerHTML = '<div class="ff-empty">No options for this selection.</div>';
      return;
    }
    step3Options.forEach(label=>{
      const subtitle = null;
      const opt = createOption({label, subtitle, isList:false});
      opt.addEventListener("click", ()=> {
        selection.step3 = label;
        delete selection.step4; delete selection.step5;
        renderStep4();
        showStep(3);
      });
      step3Container.appendChild(opt);
    });
  }

  /*****************************
   * 8) RENDER STEP 4 OPTIONS (scent) depends on step2+3
   *****************************/
  function renderStep4(){
    step4Container.innerHTML = "";
    if(!selection.step2 || !selection.step3){
      step4Container.innerHTML = '<div class="ff-empty">Choose previous options first.</div>';
      return;
    }
    const matches = FRAGRANCE_DATA.filter(i => i["Step 2"] === selection.step2 && i["Step 3"] === selection.step3);
    const scents = unique(matches.map(i => i["Step 4: Scent"])).sort();
    if(!scents.length){
      step4Container.innerHTML = '<div class="ff-empty">No scents available for this selection.</div>';
      return;
    }
    scents.forEach(label=>{
      // optional subtitle: try to show short parenthetical info (not available in JSON), so keep null
      const subtitle = null;
      const opt = createOption({label, subtitle, isList:true});
      opt.addEventListener("click", ()=> {
        selection.step4 = label;
        delete selection.step5;
        renderStep5();
        showStep(4);
      });
      step4Container.appendChild(opt);
    });
  }

  /*****************************
   * 9) RENDER STEP 5 OPTIONS (occasion) depends on step2+3+4
   *****************************/
  function renderStep5(){
    step5Container.innerHTML = "";
    if(!selection.step2 || !selection.step3 || !selection.step4){
      step5Container.innerHTML = '<div class="ff-empty">Choose previous options first.</div>';
      return;
    }
    const matches = FRAGRANCE_DATA.filter(i => i["Step 2"] === selection.step2 && i["Step 3"] === selection.step3 && i["Step 4: Scent"] === selection.step4);
    const occasions = unique(matches.map(i => i["Step 5: Occasion"])).sort();
    if(!occasions.length){
      step5Container.innerHTML = '<div class="ff-empty">No occasions available for this selection.</div>';
      return;
    }
    occasions.forEach(label=>{
      const opt = createOption({label, subtitle: null, isList:true});
      opt.addEventListener("click", ()=> {
        selection.step5 = label;
        renderResults();
        showStep(5);
      });
      step5Container.appendChild(opt);
    });
  }

  /*****************************
   * 10) RENDER RESULTS (final 5 picks)
   *****************************/
  async function renderResults(){
    resultsBox.innerHTML = "";
    if(!selection.step2 || !selection.step3 || !selection.step4 || !selection.step5){
      resultsBox.innerHTML = '<div class="ff-empty">Please complete the selections to see results.</div>';
      return;
    }

    // Find matching rows (should be at least one)
    const matches = FRAGRANCE_DATA.filter(i =>
      i["Step 2"] === selection.step2 &&
      i["Step 3"] === selection.step3 &&
      i["Step 4: Scent"] === selection.step4 &&
      i["Step 5: Occasion"] === selection.step5
    );

    if(!matches.length){
      resultsBox.innerHTML = '<div class="ff-empty">No product recommendations found for this combination.</div>';
      return;
    }

    // We will use the first match to show the 5 recommended items
    const row = matches[0];
    console.log("row", row);
    // map to product display objects
    {% comment %} const products = [
      { title: row["Perfect Match"], subtitle: "Perfect Match", price: "¬£19.99", image: `https://via.placeholder.com/1100x900?text=${encodeURIComponent(row["Final step Product 1 Perfect Match"])}` },
      { title: row["Best Alternative"], subtitle: "Best Alternative", price: "¬£17.99", image: `https://via.placeholder.com/1100x900?text=${encodeURIComponent(row["Final step Product 2 Best Alternative"])}` },
      { title: row["Premium/Niche"], subtitle: "Premium / Niche", price: "¬£24.99", image: `https://via.placeholder.com/1100x900?text=${encodeURIComponent(row["Final step Product 3 Premium/Niche"])}` },
      { title: row["Cross-Category"], subtitle: "Cross-Category Pick", price: "¬£16.99", image: `https://via.placeholder.com/1100x900?text=${encodeURIComponent(row["Final step Product 4 Cross-Category"])}` },
      { title: row["Best Value Combo"], subtitle: "Best Value Combo", price: "¬£29.99", image: `https://via.placeholder.com/1100x900?text=${encodeURIComponent(row["Final step Product 5 Best Value Combo"])}` }
    ];

    // render each product card
    const html = products.map(p => {
      return `
        <div class="ff-product-card">
          <img src="${p.image}" class="ff-product-img" alt="${escapeHtml(p.title)}">
          <div class="ff-product-info">
            <h4>${escapeHtml(p.title)}</h4>
            <p>${escapeHtml(p.subtitle)}</p>
            <div class="ff-product-bottom">
              <span class="ff-price">${p.price}</span>
              <a href="#" class="ff-shop-btn">Shop Now</a>
            </div>
          </div>
        </div>
      `;
    }).join("");

    resultsBox.innerHTML = html; {% endcomment %}

    const titles = [
      { key: "Perfect Match", label: "Perfect Match" },
      { key: "Best Alternative", label: "Best Alternative" },
      { key: "Premium/Niche", label: "Premium / Niche" },
      { key: "Cross-Category", label: "Cross-Category Pick" },
      { key: "Best Value Combo", label: "Best Value Combo" }
    ];
    
    const products = await Promise.all(
      titles.map(async item => {
        const title = row[item.key];
        const data = await getProductByHandle(title);
       
        return {
          title:data?.title,
          subtitle: item?.label,
          price: data?.price ? `$${data.price}` : "N/A",
          image: data?.image || `https://via.placeholder.com/900x1100?text=${encodeURIComponent(title)}`,
          url: data?.url || "#",
          handle:row[item.key],
          variantId:data?.variantId,
          inStock: data?.inStock ?? false
        };
      })
    );
    resultsBox.innerHTML = products.map(p => `
      <div class="ff-product-card ${p.inStock ? "" : "ff-out-of-stock"}">
        <img src="${p.image}" class="ff-product-img" alt="${escapeHtml(p.title)}">
        <div class="ff-product-info">
          <h4>${escapeHtml(p.title)}</h4>
          <p>${escapeHtml(p.subtitle)}</p>
          <div class="ff-product-bottom">
            <span class="ff-price">${p.price}</span>
            <button class="ff-shop-btn" data-handle="${p.handle}">Shop Now ‚Üí</button>
          </div>
        </div>
      </div>
    `).join("");
    document.querySelectorAll(".ff-shop-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const handle = btn.getAttribute("data-handle");
        const product = products.find(p => p.handle === handle);
        addToCartAndCheckout(product.variantId);
      });
    });
  }

  /*****************************
   * 11) STEP NAV & PROGRESS
   *****************************/
  function showStep(step){
    steps.forEach(s => s.style.display = (Number(s.dataset.step) === step) ? "block" : "none");
    currentStep = step;

    if(step === 0){
      progressWrap.style.display = "none";
      backBtn.style.display = "none";
      return;
    }

    progressWrap.style.display = "block";
    backBtn.style.display = step >= 1 ? "block" : "none";

    // progress bar: Step 1..4 map to 0..100
    if(step === 5){
      progressBar.style.width = "100%";
      stepText.textContent = "Complete";
      backBtn.style.display = "block";
      return;
    }

    const pct = ((step - 1) / totalSteps) * 100;
    progressBar.style.width = pct + "%";
    stepText.textContent = `Step ${step} of ${totalSteps}`;
  }

  /*****************************
   * 12) BACK BUTTON LOGIC
   *****************************/
  backBtn.addEventListener("click", ()=>{
    if(currentStep == 1){
      showStep(0);
      return;
    }
    if(currentStep <= 1){
      showStep(1);
      return;
    }

    // navigate back and clear deeper selections
    if(currentStep === 5){
      // from results go back to occasion step
      delete selection.step5;
      showStep(4);
      return;
    }
    if(currentStep === 4){
      // from occasion -> scent
      delete selection.step4;
      showStep(3);
      return;
    }
    if(currentStep === 3){
      delete selection.step3;
      showStep(2);
      return;
    }
    if(currentStep === 2){
      delete selection.step2;
      showStep(1);
      return;
    }
  });

  /*****************************
   * 13) START BUTTON (intro -> step1)
   *****************************/
  startBtn.addEventListener("click", ()=>{
    renderStep2();
    showStep(1);
  });

  /*****************************
   * 14) INITIALIZE: render step2 when page loads? we wait for start
   *****************************/
  showStep(0);

  /*****************************
   * 15) HELPER: escape HTML
   *****************************/
  function escapeHtml(text){
    if(!text && text !== 0) return "";
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }


  async function getProductByHandle(productTitle) {
    if (!productTitle) return null;

    const handle = productTitle
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");

    try {
      const res = await fetch(`/products/${handle}.js`);
      if (!res.ok) return null;
      const data = await res.json();
      console.log("handle", handle);
      console.log("data", data);
      return {
        title: data.title,
        handle: handle,
        variantId: data.variants[0].id,      // IMPORTANT
        price: (data.price / 100).toFixed(2),
        image: data.images?.[0] || "",
        url: `/products/${handle}`,
        inStock: data.available
      };
    } catch (e) {
      console.warn("Product not found:", handle);
      return null;
    }
  }

  async function addToCartAndCheckout(variantId) {
    try {
      await fetch("/cart/add.js", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: variantId,
          quantity: 1
        })
      });

      // Redirect to Shopify checkout
      window.location.href = "/checkout";
    } catch (err) {
      console.error("Add to cart error:", err);
    }
  }
  /*****************************
   * 16) OPTIONAL: expose state for debugging (dev only)
   *****************************/
  // window._ff = {FRAGRANCE_DATA, selection, renderStep2, renderStep3, renderStep4, renderStep5, renderResults};

})();
</script>
